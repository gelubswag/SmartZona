{% extends 'nav.html' %}

{% block main %}
<div class="container">
    <h2>Заказ #{{ order.id }}</h2>
    <p>Статус: {{ order.get_status_display }}</p>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
        {% endfor %}
    {% endif %}

    {% if user.role.name == 'customer' and order.status == 'created' %}
        <div class="card mb-4">
            <div class="card-body">
                <h5>Добавить товары</h5>
                <form method="post">
                    {% csrf_token %}
                    {{ item_form.as_p }}
                    <button name="action" value="add_item" class="btn btn-primary">
                        Добавить товар
                    </button>
                </form>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h5>Текущие товары</h5>
                <ul class="list-group">
                    {% for item in items %}
                        <li class="list-group-item d-flex justify-content-between">
                            {{ item.product.name }} ({{ item.quantity }} шт.)
                            <form method="post">
                                {% csrf_token %}
                                <input type="hidden" name="item_id" value="{{ item.id }}">
                                <button name="action" value="remove_item" class="btn btn-danger btn-sm">
                                    Удалить
                                </button>
                            </form>
                        </li>
                    {% endfor %}
                </ul>
                
                <form method="post" class="mt-3">
                    {% csrf_token %}
                    <button name="action" value="submit_order" class="btn btn-success">
                        Отправить на сборку
                    </button>
                </form>
            </div>
        </div>

    {% elif user.role.name == 'driver' and order.status == 'processing' %}
        <div class="card">
            <div class="card-body">
                <h5>Начать доставку</h5>
                <form method="post">
                    {% csrf_token %}
                    {{ loader_form.as_p }}
                    <button name="action" value="start_delivery" class="btn btn-primary">
                        Начать доставку
                    </button>
                </form>
            </div>
        </div>

    {% elif user.role.name == 'driver' and order.status == 'delivering' %}
        <form method="post">
            {% csrf_token %}
            <button name="action" value="complete_delivery" class="btn btn-success">
                Подтвердить доставку
            </button>
        </form>
    {% endif %}
</div>
{% endblock %}